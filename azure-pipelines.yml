trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  IMAGE_NAME: 'ayandakhaka1/restassured-tests'
  IMAGE_TAG: 'latest'

steps:

# 1️⃣ Checkout repo
- task: Checkout@1

# 2️⃣ Login to Docker Hub
- task: Docker@2
  displayName: 'Docker Login'
  inputs:
    command: login
    containerRegistry: 'DockerHubServiceConnection'

# 3️⃣ Build Docker image
- task: Docker@2
  displayName: 'Build Docker Image'
  inputs:
    command: build
    Dockerfile: '**/Dockerfile'
    buildContext: '.'
    tags: |
      $(IMAGE_NAME):$(IMAGE_TAG)

# 4️⃣ Push Docker image to Docker Hub
- task: Docker@2
  displayName: 'Push Docker Image'
  inputs:
    command: push
    repository: $(IMAGE_NAME)
    tags: |
      $(IMAGE_TAG)
    containerRegistry: 'DockerHubServiceConnection'

# 5️⃣ Run Docker container and execute tests
- script: |
    docker run --rm $(IMAGE_NAME):$(IMAGE_TAG)
  displayName: 'Run Tests in Docker'

# 6️⃣ Optional: Publish Surefire test results
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/target/surefire-reports/*.xml'
    failTaskOnFailedTests: true
